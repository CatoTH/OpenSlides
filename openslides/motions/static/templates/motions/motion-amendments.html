<div ng-controller="MotionListCtrl">
<div ng-controller="MotionAmendmentCtrl">
<div class="header">
  <div class="title">
    <div class="submenu">
      <a ui-sref="motions.motion.list" class="btn btn-sm btn-default">
        <i class="fa fa-angle-double-left fa-lg"></i>
        <translate>Back to overview</translate>
      </a>
      <button type="button" class="btn btn-sm btn-default"
        ng-click="toggleExpandContent(); saveExpandState(expandContent)">
        <i class="fa fa-arrows-h fa-lg"></i>
        <span ng-if="!expandContent" translate>Expand</span>
        <span ng-if="expandContent" translate>Reduce</span>
      </button>
    </div>
    <h1 translate>Amendments</h1>
    <h2 ng-if="specialMotion" translate>
      <a ui-sref="motions.motion.detail({id: specialMotion.id})">
        <translate>Motion</translate>
        <span ng-if="specialMotion.identifier">
          {{ specialMotion.identifier }} &mdash;
        </span>
        {{ specialMotion.getTitle() }}
      </a>
    </h2>
  </div>
</div>

<div class="details">

  <div class="spacer-top italic row">
    <div class="col-md-6">
      {{ amendmentsFiltered.length }} /
      {{ amendments.length }}
      <translate>amendments</translate>
    </div>
    <div class="col-md-6" ng-show="motionsFiltered.length > pagination.itemsPerPage">
      <span class="pull-right">
        <translate>Page</translate> {{ pagination.currentPage }} /
        {{ Math.ceil(amendmentsFiltered.length/pagination.itemsPerPage) }}
      </span>
    </div>
  </div>

  <div class="os-table container-fluid">
    <div class="row header-row">
      <div class="col-xs-12 main-header main-header-full">
        <ng-include src="'static/templates/motions/motion-table-filters.html'"></ng-include>
      </div>
    </div>

    <!-- main table -->
    <div class="row data-row" ng-repeat="amendment in amendmentsFiltered = (amendments
      | osFilter: filter.filterString : filter.getObjectQueryString
      | MultiselectFilter: stateFilter : getItemId.state
      | MultiselectFilter: filter.multiselectFilters.comment : getItemId.comment
      | MultiselectFilter: filter.multiselectFilters.category : getItemId.category
      | MultiselectFilter: filter.multiselectFilters.motionBlock : getItemId.motionBlock
      | MultiselectFilter: filter.multiselectFilters.recommendation : getItemId.recommendation
      | MultiselectFilter: filter.multiselectFilters.tag : getItemId.tag
      | filter: {star: filter.booleanFilters.isFavorite.value}
      | filter: {hasPersonalNote: filter.booleanFilters.hasPersonalNote.value}
      | filter: {isAmendment: filter.booleanFilters.isAmendment.value}
      | toArray
      | orderByEmptyLast: sort.column : sort.reverse)
      | limitTo : pagination.itemsPerPage : pagination.limitBegin"
      ng-mouseover="amendment.hover=true" ng-mouseleave="amendment.hover=false"
      ng-class="{'projected': amendment.isProjected().length}">
      <!-- projector column -->
      <div class="col-xs-1 centered projector" os-perms="core.can_manage_projector">
        <projector-button model="amendment" default-projector-id="defaultProjectorId">
        </projector-button>
      </div>
      <div class="no-projector-spacer" os-perms="!core.can_manage_projector"></div>
      <!-- data -->
      <div class="col-xs-3 content">
        <div class="id-col">
          <span ng-show="amendment.identifier">
            {{ amendment.identifier }}
          </span>
        </div>
        <div class="id-col-space">
          <!-- ID and title -->
          <div>
            <a class="title" ui-sref="motions.motion.detail({id: amendment.id})">{{ amendment.getTitle() }}</a>
            <a href="" ng-click="toggleStar(amendment)">
              <i class="fa" ng-class="amendment.personalNote.star ? 'fa-star' : 'fa-star-o'"
                title="{{ 'Set as favorite' | translate }}" ng-if="(amendment.personalNote.star || amendment.hover) && operator.user"></i>
            </a>
            <i class="fa fa-paperclip" ng-if="amendment.attachments_id.length > 0"></i>
          </div>
          <!-- state -->
          <div>
            <span ng-mouseover="amendment.stateHover=true" ng-mouseleave="amendment.stateHover=false"
                class="dropdown-hover-space">
              <span class="label" ng-class="'label-'+amendment.state.css_class">
                {{ amendment.getStateName() }}
              </span>
              <span os-perms="motions.can_manage" ng-class="{'hiddenDiv': !amendment.stateHover}" uib-dropdown>
                <i class="fa fa-cog pointer" uib-dropdown-toggle id="stateDropdown{{ amendment.id }}"></i>
                <ul class="dropdown-menu" aria-labelledby="stateDropdown{{ amendment.id }}">
                  <li ng-repeat="state in amendment.state.getNextStates()">
                    <a href ng-click="amendment.setState(state.id)">{{ state.action_word | translate }}</a>
                  </li>
                  <li class="divider" ng-if="amendment.state.getNextStates().length"></li>
                  <li>
                    <a href ng-if="amendment.isAllowed('reset_state')" ng-click="amendment.setState(null)">
                      <i class="fa fa-exclamation-triangle"></i>
                      <translate>Reset state</translate>
                    </a>
                  </li>
                </ul>
              </span>
            </span>
          </div>
          <!-- recommendation -->
          <div ng-if="amendment.recommendation">
            <span ng-mouseover="amendment.recommendationHover=true" ng-mouseleave="amendment.recommendationHover=false"
                class="dropdown-hover-space">
              <span class="label" ng-class="'label-'+amendment.recommendation.css_class" uib-tooltip="{{ config('motions_recommendations_by') }}">
                {{ amendment.getRecommendationName() }}
              </span>
              <span os-perms="motions.can_manage" ng-class="{'hiddenDiv': !amendment.recommendationHover}" uib-dropdown>
                <i class="fa fa-cog pointer" uib-dropdown-toggle id="recommendationDropdown{{ amendment.id }}"></i>
                <ul class="dropdown-menu" aria-labelledby="recommendationDropdown{{ amendment.id }}">
                  <li ng-repeat="recommendation in amendment.state.getRecommendations()">
                    <a href ng-click="amendment.setRecommendation(recommendation.id)">
                      {{ recommendation.recommendation_label | translate }}
                    </a>
                  </li>
                  <li class="divider" ng-if="amendment.state.getRecommendations().length && amendment.recommendation"></li>
                  <li ng-if="amendment.recommendation">
                    <a href ng-click="amendment.setRecommendation(null)">
                      <i class="fa fa-exclamation-triangle"></i>
                      <translate>Reset recommendation</translate>
                    </a>
                  </li>
                </ul>
              </span>
            </span>
          </div>
          <!-- Submitters -->
          <div ng-if="amendment.submitters.length">
            <small>
              <span class="optional" translate>by</span>
              <span class="optional" ng-repeat="submitter in amendment.submitters | limitTo:1">
                {{ submitter.get_full_name() }}<span ng-if="!$last">,</span></span><span ng-if="amendment.submitters.length > 1">,
                ... [+{{ amendment.submitters.length - 1 }}]</span>
              <!-- sorry for merging them together, but otherwise there would be a whitespace because of the new line -->
            </small>
          </div>
          <!-- hover menu -->
          <div ng-if="amendment.isAllowed('update')" ng-class="{'hiddenDiv': !amendment.hover}">
            <small>
              <span ng-if="amendment.isAllowed('update')">
                <a href="" ng-click="openDialog(amendment)" translate>Edit</a>
              </span>
              <span ng-if="amendment.isAllowed('delete')"> &middot;
                <a href="" class="text-danger"
                    ng-bootbox-confirm="{{ 'Are you sure you want to delete this entry?' | translate }}<br><b>{{ amendment.getTitle() }}</b>"
                    ng-bootbox-confirm-action="delete(amendment)" translate>Delete</a>
              </span>
            </small>
          </div>
        </div>
      </div>
      <div class="col-xs-5">
        <!-- The diff -->
        <section class="motion-text-holder" ng-init="paragraphs = amendment.getAmendmentParagraphsLinesDiff()">
          <div ng-repeat="paragraph in paragraphs" class="motion-text motion-text-diff line-numbers-none">

            <h3 ng-if="paragraph.diffLineTo == paragraph.diffLineFrom + 1" class="amendment-line-header">
              {{ ('In line %FROM%' | translate).replace('%FROM%', paragraph.diffLineFrom) }}:
            </h3>
            <h3 ng-if="paragraph.diffLineTo != paragraph.diffLineFrom + 1" class="amendment-line-header">
              {{ ('From line %FROM% to %TO%' | translate).replace('%FROM%', paragraph.diffLineFrom).replace('%TO%', paragraph.diffLineTo - 1) }}:
            </h3>

            <div ng-bind-html="paragraph.text | trusted"></div>
          </div>
        </section> <!-- Diff end -->
      </div>
      <div class="col-xs-4" style="width: calc(33.33% - 70px);">
        <div ng-repeat="(id, field) in noSpecialCommentsFields">
          <div ng-mouseover="field.hover=true" ng-mouseleave="field.hover=false">
            <i class="fa pointer spacer-right" ng-class="field[amendment.id] ? 'fa-caret-down' : 'fa-caret-right'"
              ng-click="field[amendment.id] = !field[amendment.id]"
              ng-if="isCommentExpandable(amendment.comments[id])"></i>
            <strong>{{ field.name }}</strong>
            <i class="fa fa-pencil pointer" os-perms="motions.can_manage_comments"
              ng-show="field.hover && amendment.hover" ng-click="editComment(amendment, id)"></i>
          </div>
          <div ng-if="!field[amendment.id]">
            {{ getCommentPreview(amendment.comments[id]) }}
          </div>
          <div ng-if="field[amendment.id]" ng-bind-html="amendment.comments[id]"></div>
        </div>

        <div class="spacer-top" os-perms="motions.can_manage">
          <button class="btn-link" ng-click="createModifiedAmendment(amendment)">
            <translate>Create modified amendment</translate>
          </button>
        </div>

      </div>
    </div>

    <ul uib-pagination
        ng-show="amendmentsFiltered.length > pagination.itemsPerPage"
        total-items="amendmentsFiltered.length"
        items-per-page="pagination.itemsPerPage"
        ng-model="pagination.currentPage"
        ng-change="pagination.pageChanged()"
        class="pagination-sm"
        direction-links="false"
        boundary-links="true"
        first-text="&laquo;"
        last-text="&raquo;">
    </ul>

  </div> <!-- container -->
</div>
</div>
</div>
